#!/command/with-contenv bash
#shellcheck shell=bash disable=SC2015,SC1091,SC2154
# -----------------------------------------------------------------------------------
# Copyright 2020-2026 Ramon F. Kolb - licensed under the terms and conditions
# of GPLv3. The terms and conditions of this license are included with the Github
# distribution of this package, and are also available here:
# https://github.com/sdr-enthusiasts/planefence4docker/
#
# This package may incorporate other software and license terms.
# -----------------------------------------------------------------------------------
#

source /scripts/common
if [[ -f /usr/share/planefence/persist/planefence.config ]]; then
    source /usr/share/planefence/persist/planefence.config
fi

"${s6wrap[@]}" echo "Initial Planefence check..."

if [[ ! -f /usr/share/planefence/persist/planefence.config ]]; then
    /usr/share/planefence/prep-planefence.sh
fi

# Post message to any old plane-alert page to inform user that Planefence has been updated
if [[ -f /usr/share/planefence/html/plane-alert/index.html ]] && \
   ! grep -q "\!-- pa_updated --" /usr/share/planefence/html/plane-alert/index.html; then
    sed -i "s|</h1>|</h1><h2>IMPORTANT:<br>This page is no longer maintained. To see current Plane-Alert entries, click <a href=\"${PA_PF_LINK:-..}?mode=pa\">here</a>.</h2><\!-- pa_updated -->|g" /usr/share/planefence/html/plane-alert/index.html
    sed -i "s|<hr>Note - soon.*<hr>||g" /usr/share/planefence/html/plane-alert/index.html
fi

"${s6wrap[@]}" echo "Initial Planefence check done..."
